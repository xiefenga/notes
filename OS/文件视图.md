## 磁盘

一块磁盘由多个**盘片**叠加而成，盘片的表面涂有磁性物质来记录二进制数据，涂有磁性物质的表面为**盘面** 

正反两面都可涂上磁性物质，一个盘片可能会有 1-2 个盘面，每个盘面都可以存数据

每个盘面都被划分为一圈圈**磁道**（与跑道类比，一个跑道就是一个磁道），不同盘片上位于相同位置的磁道构成的圆柱体称为**柱面** 

一个磁道被划分为一块一块的**扇区** 

- 每个扇区存储的数据量相同，最内侧磁道上的扇区面积最小，因此数据密度最大
- 磁盘的读写以扇区为基本单位，一个扇区一般大小为 512 bytes 



![](https://img-blog.csdnimg.cn/20200330223552242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDM5NTY4Ng==,size_16,color_FFFFFF,t_70)

### 磁盘编址

磁盘通过**磁头**来读写扇区的数据，每个盘面对应一个磁头，所有的磁头都连在同一个磁臂上，因此所有磁头只能“共进退”

磁盘的读写以扇区为基本单位，所以需要对扇区进行编址，根据磁盘结构定位一个扇区需要确定：柱面号、磁头号、扇区号

所以磁盘的地址是三维的：<柱面, 磁头, 扇区>

所以最直接使用磁盘的方式，也是最终和磁盘控制器交互的方式，通过向控制器传递柱面、磁头、扇区、缓存位置即可完成磁盘数据读取

进一步我们可以给扇区编号，只需要给出一维的扇区号，就可以根据硬件信息算出扇区号对应的三维地址

### 磁盘读写

读写数据时，磁头必须定位到指定的磁道上的指定扇区的开始处

1. 寻道：控制移动臂到达指定柱面，选择磁头号
2. 旋转：等待要读写的扇区旋转到磁头下
3. 数据传送

寻道和等待旋转时间较长，数据传送时间非常快可忽略不计

所以磁盘完成数据读写所需的时间 = 寻道时间 + 旋转延迟 + 传送时间

###  磁盘块

一般程序往往会连续使用占据连续几个扇区的数据，在磁盘的读写过程中，寻道和等待旋转的时间所占比重很大

虽然扇区是磁盘最小的物理存储单元，但是操作系统可以一次读写**多个连续**扇区，这样会大大提升磁盘读写的速度

操作系统将相邻的扇区组合在一起形成一个磁盘块，通过对磁盘块进行管理提升读写效率（通过磁盘碎片浪费换取时间）

### 磁盘调度

磁盘可能同时接收到若干进程的 I/O 请求，所以多个进程需要通过请求队列来使用磁盘

为了满足较快的访问速度，需要对磁盘请求进行调度以达到**平均访问延迟小** 

**FCFS**

FCFS 永远是最简单、最公平、最直观的调度算法

但是对于磁盘访问来说，磁头臂的移动是随机的，寻道性能较差

**SSTF**

Shortest-seek-time First，最短寻道时间优先：优先处理**靠近当前磁头位置**的请求

该算法具有良好的寻道性能，但是存在**”饥饿“** 

**SCAN磁盘调度**

- SSTF + 中途不回折（电梯算法）
  - 磁头每次向一个方向移动，遇到最近的 I/O 请求便进行处理，到达最后一个柱面后再向相反方向移动
  - 对最近扫描所跨越区域的请求响应较慢
- 循环扫描（C-SCAN）
  - 移动臂总向一个方向扫面，归途中不提供服务
  - 适用于不断有大量柱面均匀分布的请求的情形
- Look 调度
  - 该方向上没有请求，立即反向，而不是等到达最后一个柱面

## 文件

对于操作系统来说磁盘的管理抽象为管理磁盘块，但是对于用户来说，文件才是磁盘的最小分配单元。

所以需要在磁盘块的基础上抽象出文件，文件的本质是**字符序列**（字符流），所以需要建立字符流到盘块号的映射关系

### 文件控制块

FCB 类似于 PCB，FCB 中包含了文件的一些信息，包括基本信息（文件名、物理地址、逻辑结构、物理结构等），存取控制信息（读写权限等），使用信息（文件最后修改的日期等）。

**索引节点（inode）**

在目录表中查找数据时只需要用到文件名，使用 FCB 有些浪费空间

使用索引节点让目录瘦身，只有找到文件名时再读取需要的信息，Unix 文件系统使用了 inode 替代 FCB

### 物理结构

扇区是磁盘最小的物理存储单元，操作系统将相邻的扇区组合在一起形成一个磁盘块进行管理。

磁盘块是文件系统读写数据的最小单位（内存和磁盘 I/O 传输以块为单位），在很多操作系统中，磁盘块的大小和页面大小相同。

在内存管理中，进程的逻辑地址被分为一个个页面，在外存管理中，文件的逻辑地址被分为一个个块。

读写文件时则要确定的值为：<起始块号, 块内偏移>

#### 连续分配

连续分配要求每个文件在磁盘上占有一组连续的块，文件目录中记录着文件的起始块号和长度：

![](https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201227212757974.png)

优点：

1. 支持顺序访问和随机访问
2. 在顺序访问时速度最快

缺点：

1. 采用连续分配的文件不方便拓展
2. 存储空间利用率低，会产生难以利用的磁盘碎片
3. 使用紧凑技术处理磁盘碎片代价大

#### 链接分配

链接分配解决了连续分配的所有问题，采用链接分配，每个文件都是一个磁盘块链表。

每个目录条目会包含该文件的首个磁盘块的指针和最后一个磁盘块的指针。指针初始为 null，表示一个空的文件。

<img src="https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201227214524359.png" style="zoom: 67%;" />

优点：

1. 方便文件拓展
2. 没有碎片问题，磁盘利用率高

缺点：

1. 只支持顺序访问，不支持随机访问，查找效率低
2. 指向下一个磁盘块的指针也会占据空间
3. 如果其中一个磁盘块发生错误：指针丢失或损坏则发生错误

#### 文件分配表

链接分配的一个变种是使用**文件分配表（FAT）**，将用于链接文件的各物理块的指针显式的存放到一张表（FAT）中。

文件目录中的每个条目只需要记录文件的起始块号即可。

一个卷只有一张 FAT，开机时将FAT读入内存并常驻内存。FAT 中的表项在物理上连续存储，所以物理块号可以隐含。

<img src="https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201227215104720.png" style="zoom: 67%;" />

优点：

1. 支持顺序访问，也支持随机访问
2. 方便文件拓展
3. 磁盘利用率高，没有碎片问题

缺点：FAT 需要占据一定的空间

#### 索引分配

链接分配解决了连续分配的问题，但是如果没有 FAT 时，链接分配无法实现高效的直接访问，因为块指针和块一起分散在整个磁盘上，必须按序读取。

索引分配将所有指针放在一起，即**索引块（index block）**。

系统会为每个文件建立一个**索引表**，索引表中记录了文件的各个逻辑块和其对应物理块的映射，索引表被存放的物理块称之为索引块。而文件存放的物理块称之为数据块。

<img src="https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201228094950762.png" style="zoom: 50%;" />

如果一个文件过大，一个磁盘块无法装下整个索引表，该如何解决。例如：一个每个磁盘块 1 KB，每个表项 4B，则一个磁盘块最多存放256个索引项。

**链接方案**

将索引块最后一个表项存放的地址变为下一个索引块的物理块号，如果没有下一个索引块则为 null。

但是这样是低效的，因为访问后续的索引表需要顺序先访问前面的索引块。

**多级索引**

类似于多级页表，建立多层索引，采用 K 层索引，则访问一个数据块需要 K + 1 次磁盘读写。

<img src="https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201228100259006.png" style="zoom:50%;" />

**混合索引**

索引块中的索引表中即存在直接索引，也存在多级索引。例如将索引块的前几个（比如12）直接指向文件的物理块，后面的几个一次指向一级简介块，二级间接块等。这样小文件就可以直接指向物理块。

这种方案用于基于 Unix 的文件系统，这些信息存在 inode 中。

<img src="https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/1-140F2031911211.jpg" style="zoom:50%;" />

## 文件系统

文件系统提供高效和便捷的磁盘访问，以便允许轻松存储、定位、提取数据。

### 目录结构

目录，表示一个文件集合

- 单级目录
  - 早期操作系统不支持多级目录，整个系统中只能建立一张目录表，每个文件占一个目录项
- 两级目录
  - 早期的多用户操作系统，采用两级目录结构：分为**主目录（MFD）**和**用户文件目录（UFD）** 
  - 两级目录结构允许不同用户文件重名，也可以在目录上实现用户访问限制
  - 两级目录依旧缺乏灵活性，用户不能对自己的文件进行分类
- 树形目录
  - 从根路目录出发的路径为绝对路径，从当前目录出发的路径为相对路径
  - 树形目录可以很方便的对文件进行分类，层次结构清晰，也能有效的进行文件的管理和保护
  - 但是树形结构不便于实现文件的共享
- 无环图目录
  - 和树形目录几乎相同，不同的是**不同文件名可以指向相同的文件**，甚至可以指向同一个目录
  - 需要为每一个共享节点设置一个共享计数器，用于记录此时有多少个地方正在共享该节点
  - 删除节点请求时，只删除该目录项，并且共享计数器的值减少1，只有共享计数器的值为0时，才会真正删除节点

![单级目录](https://oss.xiefeng.tech/images/20220331130722.svg)

![两级目录](https://oss.xiefeng.tech/images/20220331130807.svg)

### 文件共享

#### 硬链接

在 FCB / inode 中有引用计数，多个目录项可以指向同一个索引节点。

![](https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201228105742525.png)

#### 符号链接

![](https://xf-blog-imgs.oss-cn-hangzhou.aliyuncs.com/img/image-20201228105804962.png)

### 文件系统存储

在磁盘上，文件系统可能包括如下信息：启动存储在哪里的操作系统、总的块数、空闲块的数量和位置、目录结构以及各个具体文件等。

一个磁盘可以被划分为多个分区，包含文件系统的分区通常称为**卷** 

- 引导控制块
  - 通常为卷的第一块，包含从该卷引导操作系统的所需信息，如果不含操作系统可没有
  - UFS（Unix 文件系统）通常称之为**引导块**，NTFS（Windows NT 文件系统）称之为分区**引导扇区**
- 卷控制块
  - 包括卷的详细信息，例如分区的块的数量，块的大小，空闲块的数量和指针，空闲的FCB 数量和FCB指针
  - UFS 称之为**超级块**，NTFS 将该信息存储在主控文件表中
  - 所谓的**挂载**就是读取磁盘中的**超级块**
- 目录
  - 用于组织文件
  - NTFS 中，该信息存储在主控文件表中
  - UFS 中，它包含文件名和相关的 inode
- 每个文件的 FCB
  - 包含该文件的信息
  - 有一个唯一的标识号，和目录条目相关联
  - NTFS 中这些信息存储在 FAT 中
- 整个系统的打开文件表
- 每个进程的打开文件表
- 安装表
  - 位于内存，包含每个安装卷的有关信息





