# 网络层

运输层提供了进程到进程之间的通信，**网络层**则提供了**主机到主机**之间的通信，运输层的服务则依赖于网络层。

网络层在协议栈中是最复杂的层次，网络层可以被分解为两个相互作用的部分：**数据平面**和**控制平面**。

- **数据平面：**是每一台路由器的功能，即分组的**转发**

- **控制平面：**控制数据报在源到目的主机中路由器之间的路由方式

网络层的作用从表面看极为简单，就是将分组从一台主机转发到另一台主机，网络层具有两种功能：

1. 转发：路由器将输入链路的分组移动到适当的输出链路，转发即移动这个动作
2. 路由选择：分组从发送方到接收方的路径，这个选择的算法即是路由选择

转发是一个本地动作，通常用硬件实现；路由选择是确定分组从源到目的地所采取的处理过程，通常用软件实现。


因特网的网络层只提供了单一的服务，**尽力而为服务**（best effort service）。

# 路由器

**分组交换机**是指一台通用的分组交换设备，它根据分组首部字段的只，从输入链路的接口到输出链路的接口移动分组。

分组交换机分为：

- **链路层交换机**：基于链路层帧中的字段值做出转发决定
- **路由器**：基于网络层数据报中的首部字段做出转发决定

## 组成

- 输入端口：执行必要的链路层和物理层功能从输入链路接收分组；通过查询转发表执行查找功能，通过交换结构转发到输出端口
- 输出端口：存储从交换结构接收的分组；执行必要的链路层和物理层功能在输出链路上传输这些分组
- 交换结构：将路由器的输入端口连接到输出端口
- 路由选择处理器：执行路由选择协议，维护路由选择表和关联链路状态；在 SND 路由器中，负责和远程控制器通信接收转发表

## 转发

每台路由器中都有一个**转发表**，路由器检查到达的分组首部的一个或多个字段，使用这些首部值在转发表中索引找出对应的输出端口。

转发表的计算和更新由路由选择处理器完成，转发表的查找在输入端口完成。

转发表从路由选择处理器经过独立总线复制到线路卡，每个输入端口都会有一个转发表的副本，转发决策可以在出入端口本地做出，无须集中调用路由选择处理器。

转发表无需包含所有的 IP 地址，仅需包含几个表项即可。路由器用分组目的地址的**前缀**（prefix）与表项进行匹配，当有多个匹配时，路由器使用**最长前缀匹配规则**。

# IPv4

![](../assets/IPv4.png)

## 数据报格式

- **首部长度**：因为一个 IPv4 数据报可能包含一些可变数量的选项，所以需要使用该 4 bit 来确定 IP 数据包中载荷实际开始的地方

- **服务类型**：以便使用不同类型的IP数据报能相互区别开来，比如实时数据报、非实时流量
- **数据报长度**：IP数据报的总长度（即 IP 首部 + 数据），字段长 16bit，所以 IP 数据包理论上最大长度为 65535 bit
- **标识、标志、片偏移**：用于实现 IP 分片
- **寿命**：用来确保数据包不会永远在网络中循环，每经过一台路由器该字段值减一，为 0 则会丢弃该数据报
- **协议**：该字段指示了IP数据报的数据部分应该交给哪个运输层协议，只有到达目的主机才有用
- **首部检验和**：用于帮助路由器检测收到的 IP 数据报中的**比特错误**
- **选项**：该字段允许 IP 首部被扩展，但导致了路由器处理一个数据报所需的时间变化可能很大

## 数据报分片

并不是所有链路层协议都能承载相同长度的网络层分组，例如以太网帧能够承受不超过1500字节的数据，而有的广域网链路的帧可承载不超过576字节的数据。

**MTU**：最大传输单元（Maximum Transmission Unit）是一个链路层能承载的最大数据量。

常见网络 MTU：

![](http://oss.xiefeng.tech/img/20210731170940.png)

因为每个 IP 数据报需要封装在链路层帧中进行传输，所以 MTU 严格的限制了 IP 数据报的长度，关键在于发送方和目的主机之间的每段链路使用的链路层不一定相同，而每种协议的 MTU 也不一定相同。

当遇到 MTU 比 IP 数据报长度小的时候，则需要将 IP 数据报中的数据分片成两个或更多个较小的 IP 数据报，用单独的链路层帧封装这些较小的 IP 数据报，这些较小的数据报称为**片**（segment），所以数据报分片是发生在网络中的**路由器**中的。

片在到达**目的地运输层**之前需要重新组装，运输层希望收到完整的报文，为了坚持网络内核保持简单的原则，IPv4 的设计者将数据包的重新组装工作放在端系统中。

为了让目的主机能执行组装的任务，就有了标识、标志和片偏移字段。

**标识：** **发送主机**会为每个数据报都生成一个的标识号，被分片的数据每片都具有相同的标识号

**偏移：**偏移字段指了该片在原始 IP 数据报的位置，可以用来确定是否有片丢失

**标志：** 为了让**接收主机**明确接收到了最后一个分片，分片的最后一个数据报的标志位为 0，其他的都是 1

分片可能发生在源主机、路由器，只要出现 IP 数据报的长度小于当前链路的 MTU 时就会发生分片

## IP 编址

主机与物理链路之间的边界叫**接口**，路由器通常具有多个接口，IP 要求每台主机和路由器每个接口拥有自己的 IP 地址。

因此确切的说，一个 IP 地址与一个接口相关联，而不是与主机或路由器相关联。

### 表示方法

**IP地址**长度为32bit，因此总共有 $2^{32}$ 个可能的IP地址（大约40亿个），因特网中每台主机和路由器上的每个接口，都必须有一个全球唯一的 IP 地址。

书写形式：点分十进制，即每个字节使用十进制书写，每个字节之间以 `.` 分隔

例如：`193.32.216.9`	=>	`11000001 00100000 11011000 00001001`

**子网：** 互联几个主机接口和一个路由器的网络形成一个子网

子网掩码定义了子网的地址，子网掩码：`233.1.1.0/24`	指示最左侧 24 比特定义了子网地址

### 地址分配

因特网的地址分配策略：**无类别域间路由选择**（**CIRD**）

32 bit 的 IP 地址被分为两部分：`a.b.c.d/x`，其中 x 指示了地址的前 x bit 为网络号，剩余的 (32 - x) bit 为设备号。

网络部分经常被称为该地址的**前缀**，一个组织通常被分配一块连续的地址，即具有相同**前缀**的一段地址。当组织外部的路由器转发一个数据报时仅需考虑前 x bit，所以大大减少了转发表的表项；只有组织内部的路由器进行转发分组时，才会考虑剩余的比特。

最长前缀匹配原则：

// todo: 220 221 图片

### 分类编址

在 CIRD 被采用之前，IP 地址的网络部分被限制为长度为 8、16、24 bit，分别被称为 A、B、C 类网络。

![](http://oss.xiefeng.tech/img/20210725125418.jpg)

## 特殊IP地址

- `0.0.0.0`：在本网中表示本机，在路由表中表示默认路由
- `网络号为0 主机号特定`：表示本网内的特定主机
- `255.255.255.255`：本网广播地址
- `网络号特定 主机号为0`：表示一个网络
- `网络号特定 主机号全1`：表示对一个特定的网络广播
- `127.0.0.0 ~ 127.255.255.255`：本地回环地址

**私有地址**

- `10.0.0.0 ~ 10.255.255.255`
- `172.16.0.0 ~ 172.31.255.255`
- `192.168.0.0 ~ 192.168.255.255`

## 获取IP地址

手工可以配置，但更多的是使用**动态主机配置协议**（Dynamic Host Configuration，DHCP），又称**即插即用协议**或**零配置协议**

DHCP可以给一个主机分配一个固定的IP或临时的IP地址，除了地址还可以告诉主机子网掩码，默认网关（第一跳路由器地址）和本地DNS服务器地址。

对于一台新连接的主机，DHCP 需要四步：

1. **DHCP服务器发现**

   通过DHCP 发现报文，使用DUP向端口47广播，且源地址为 `0.0.0.0`

2. **DHCP服务器提供**

   DHCP服务器收到报文之后，用DHCP提供报文响应，仍然广播，报文中有发现报文的事务ID，IP地址，网络掩码，IP地址租用期等

3. **DHCP请求**

   客户从一个或多个服务器提供中选择一个，并向选择的服务器提供DHCP请求报文响应，回显配置的参数

4. **DHCP ACK**

   服务器用DHCP ACK报文对DHCP请求报文进行响应，证实所要求的参数

## 网络地址转换（NAT）

![](http://oss.xiefeng.tech/img/20210725125838.png)

# ICMP

因特网控制报文协议，IP 协议的助手，用于告知错误、传递信息。

ICMP 报文使用 IP 来承载，是源抑制报文，最初的目的是拥塞控制。

## 协议格式

组成字段：类型、子类型、校验和

![](http://oss.xiefeng.tech/img/20210731172015.png)

## 报文类型

![](http://oss.xiefeng.tech/img/20210731172149.png)

## ping

类型 0 和 类型 8 分别为 ping 的响应和请求报文

ping 命令参数：

- `-l`：指定负载中的数据长度
- `-f`：指定 IP 不能分片

# IPv6

![](../assets/IPv6.png)

- **扩大的地址：**IPv6 采用 128 bit 表示一个地址，这确保了全世界将不会用尽 IP 地址
- **固定首部：**IPv6 采用了简化高效 40 bit 首部，允许路由器更快的处理 IP 数据报
- **有效载荷长度：**数据报中数据的长度
- **分片：**IPv6 不允许在中间路由器上进行分片和重新组装，这种操作只能在源和目的主机进行，如果一个 IPv6 报文太大无法转发到输出链路，则会丢弃该报文并向发送方发一个”分组太大“的 ICMP 差错报文
