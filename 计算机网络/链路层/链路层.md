# 链路层

链路层负责将实现主机到主机的网络层数据报从当前节点沿着链路传递给下一个节点，链路层的分组称为**帧**，链路层的协议取决于当前的这一路段的链路特点，一个数据报在传输过程中可能会经过不同的链路层协议处理。

物理层用于将链路层的**帧**中的一个**比特**从一个节点移动到另一个节点，物理层才是真正传输数据的层次。物理层和链路层一样，使用的协议取决于当前的链路传输媒体相关。

## 提供的服务

- **成帧**：需要将网络层的数据封装在链路层帧中进行传输

- **链路接入**：媒体访问控制（Medium Access Control，**MAC**）协议规定了帧在链路上的传输规则。

- **可靠交付**：对于高差错率的链路（例如：无线链路）提供可靠交付

- **差错检测和纠正**：检测传输过程中的比特差错，能够定位差错位置甚至纠正差错

## 实现位置

链路层的主体部分在**网络适配器**实现，网络适配器也叫做网络接口卡。

大部分的链路层在硬件中实现，但部分链路层是在运行于主机 CPU 上的软件中实现的功能。

链路层的软件组件实现了高层链路层功能（如组装链路层寻址信息和激活控制器硬件，响应控制器中断）

链路层是软件和硬件的结合体，是协议栈中软件和硬件交接的地方。

# 多路访问协议

链路层具有两种不同的链路：

- **点对点链路：**由链路一端的单个发送方和另一端的单个接收方组成
- **广播链路：**让多个发送和接收节点连接到相同的、单一的、共享的广播信道上

对于广播链路来说，因为所有的节点都能传输帧，所以多个节点可能会同时传输，所有节点同时接收多个帧，传输的帧发生了**碰撞**，帧就不会被有效的的接收。

即存在多路访问问题：如何协调多个发送和接收节点对一个共享广播信道的访问

## 信道划分协议

- **时分多路复用（TDM）**

  TDM将时间划分为**时间帧**，每个时间帧划分为N个**时隙**，每个时隙分配给一个节点，每个节点只能在循环的属于它的时隙内发送分组。

- **频分多路复用（FDM）**

  FDM将信道划分为不同的频段，并把每个频率分配给N个节点中的一个。

- **码分多址（CDMA）**

  CDMA对每个节点分配一种不同的**编码**，然后节点用它唯一的编码来对它发送的数据进行编码。

## 随机接入协议

在随机接入协议中，一个传输节点总是以信道的全部速率进行发送，有碰撞时，涉及碰撞的节点反复重发直到无碰撞为止（但不是立即发，而是等待一个随机的时延）。

- **时隙ALOH**

  所有的帧L比特，时间被划分为L/R的时隙，节点只在时隙起点开始传输；

  当节点有帧发送时，等到下一个时隙开始才开始传输，没有碰撞就发送成功，有碰撞以概率p在后续的时隙中重传，直到成功。（p为0~1的值，和抛硬币一样，正面传，反面不传）

- **ALOH**

  节点有帧要传，立刻就传，如果经理碰撞，以概率p重传。

- **载波侦听多路访问（CSMA）**
  1. **载波侦听**，传输前节点先看看有没有别的节点正在传输，有就等待
  2. **碰撞检测**，传输时也侦听信道，如果和别的节点一起传输，则停止传输等待一段时间

- **具有碰撞检测的载波侦听多路访问（CSMA/CS)**

## 轮流协议

- **轮询协议**
- **令牌传递协议**

# MAC地址

类似于 IP 地址，并不是主机或者路由器具有链路层地址，而是它们的**网络适配器**具有链路层地址，具有多个网络接口的主机则具有多个链路层地址。

链路层地址也被称为：**LAN地址**、**物理地址**、**MAC地址**

MAC 地址大小为 6 byte，一般采用 16 进制进行表示：`1A-23-F9-CD-06-9B`

MAC广播地址：`FF-FF-FF-FF-FF-FF`

MAC 地址是唯一的，即没有任何两块适配器具有相同的地址。

## 地址解析

因为存在网络层地址和链路层地址，所以在链路层传输时需要进行地址的转换。

在因特网中，使用 ARP 将 IP 转换为 MAC 地址，类似于 DNS

为了发送数据报到某台主机，链路层在接收到数据报时只知道目的主机的 IP 地址，而链路层传输需要的是 MAC 地址，需要使用 ARP 获取 IP 地址所对应的 MAC 地址。

主机的 ARP 模块接收**相同局域网**中的任何 IP 为输入，返回相对应主机的 MAC 地址。

每台主机的内存中都有一个**ARP表**，存储着 IP 地址到 MAC 地址的映射关系，以及该表项的寿命。

### ARP工作过程

当主机需要发送数据报时，通过 ARP 查询该表得到目的主机的 MAC 地址，当表中没有该主机的记录时，则需要更新表项。

发送方构造一个特殊的分组（ARP 查询分组），其中包括发送方的 IP 地址、MAC 地址、接收方的 IP 地址，接着将其封装在链路层帧中并使用广播地址进行发送，通过询问子网中所有的主机来得到某个 IP 对应的 MAC 地址。

当匹配的主机接收到该分组之后，会给查询主机返回一个 ARP 响应分组，使发送方可以更新 ARP表。

查询 ARP 报文在广播帧中发送，响应 ARP 报文是在标准帧中发送。

### 免费 ARP

当主机启动的时候，会发送一个免费 ARP 请求。免费 ARP 是一种特殊的 ARP 请求，它并非期待得到 IP 对应的 MAC 地址，而是请求自己的 IP 地址的 MAC 地址。

普通 ARP 报文中的目标 IP 地址是其他主机的 IP 地址；免费 ARP 的请求报文中，目标 IP地址是自己的 IP 地址。

免费 ARP 请求的作用：

- 起一个宣告作用，为了告诉其他计算机自己的 IP 地址和 MAC 地址。
- 可用于检测IP地址冲突，当收到了 ARP 响应报文，则说明网络内已经存在使用该IP地址的主机
- 可用于更新其他主机的 ARP 缓存表，如果更换了网卡，发送免费的 ARP 数据包将更新其他主机的 ARP 缓存表

### ARP代理

地址解析协议工作在一个网段中，当局域网内主机发起跨网段的 ARP 请求时，出口路由器（网关）则用自身的地址回复该请求，这个过程称为 ARP 代理。

像路由器这样的设备，代替处于另一个网段的主机回答本网段主机的 ARP 请求。

例如，主机PC1（192.168.20.66/24）需要向主机PC2（192.168.20.20/24）发送数据报，主机 PC1 将发送 ARP 请求报文请求 192.168.20.20 的 MAC 地址。路由器识别出报文的目标地址属于另一个子网，因此向请求主机回复自己的 MAC 地址。之后 PC1 将发往 PC2 的数据报都发往路由器，路由器将数据包转发到目标主机PC2。

代理 ARP 协议使得子网化网络拓扑对于主机来说是透明的，路由器以一个不真实的的MAC地址欺骗了源主机。

# 以太网

以太网几乎占领着现有的有线局域网市场。

## 优势

1. 第一个广泛部署的高速局域网
2. 简单
3. 一直更新产生高速率版本
4. 硬件便宜

## 演变

- 初始太局域网使用同轴电缆总线来互联节点，
- 1990s演变成基于**集线器**的星型拓扑以太网，
- 21c集线器被交换机替代

**集线器**（hub）：一种作用于各个比特而不是帧，集线器作用就是将到达的比特重新生成放大能量强度并转发

## 以太网帧结构

![](assets/以太网帧.jfif)

- **前同步码**：前7B都是`10101010`，后1B为`10101011`，前7B用于”唤醒“接收适配器，将接收和发送方时钟同步

- **类型字段**：类型字段允许以太网复用多种网络层协议

- **CRC**：循环冗余检测

# 交换机

交换机的任务是接收入链路层帧并将他们转发到出链路，不同于路由器，交换机的接口并不具有链路层地址，交换机自身对子网中的主机和路由器是**透明的**。

## 交换机的功能

- 过滤：决定一个帧应该转发到某个接口还是应该将其丢弃的交换机功能
- 转发：决定一个帧应当被导向到哪个接口

交换机的过滤和转发借助于**交换机表**，类似于路由器的路由表，每个表项的组成：

1. 局域网中一台主机的 MAC 地址
2. 通向该 MAC 地址的接口
3. 表项放置在表中的时间

|       地址        | 接口 | 时间 |
| :---------------: | :--: | :--: |
| 62-FE-F7-11-89-A3 |  1   | 9:32 |
| 7C-BA-B2-B4-91-10 |  3   | 9:36 |
|        ...        | ...  | ...  |

## 工作过程

当接收到链路层帧时：

1. 表中没有该 MAC 地址，除了入链路接口，广播该帧
2. 对于 MAC 地址对应的接口和入链路接口一样，执行过滤功能丢弃该报文
3. 正确情况，转发

交换机是**自学习**的，默认交换机表为空：

2. 对于每个接口接收到的入帧，交换机存储  源地址字段、达到的接口、当前时间
3. 在一段时间（老化期）后，交换机没有接收到以该地址作为源的帧，就从表中删除该记录

所以交换机是即插即用的设备，且不需要进行干预

## 和路由器的比较

- 交换机和路由器都是一个存储转发分组的设备
- 交换机使用 MAC 地址，路由器使用 IP 地址
- 交换机是第二层，路由器是第三层
- ……

